<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUMOR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a1f;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            width: 1280px;
            height: 720px;
            background: #1e1e23;
        }

        canvas {
            display: block;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="1280" height="720"></canvas>
    </div>

    <script>
        // ============================================
        // CONSTANTS
        // ============================================

        const COLORS = {
            DARK_GRAY: '#1e1e23',
            LIGHT_GRAY: '#64646e',
            DIM_GRAY: '#3c3c41',
            WHITE: '#ffffff',
            BLACK: '#000000',
            BRIGHT_YELLOW: '#ffdc64',
            MUTED_PURPLE: '#5a466e',
            SOFT_BLUE: '#648cb4',
            DARK_PURPLE: '#281e32',
            LIGHT_PURPLE: '#a08cb4',
            DARK_BLUE: '#1e3250',
            LIGHT_BLUE: '#6496c8'
        };

        const GAME_PHASE = {
            INTRO: 'intro',
            PLAYING: 'playing',
            ENDING: 'ending',
            COMPLETE: 'complete'
        };

        const MAYA_STATUSES = [
            "Beloved teacher. 8 years at Millbrook Elementary.",
            "Some parents have requested different teachers.",
            "Placed on administrative leave pending review.",
            "Husband moved out. 'Can't live under this spotlight.'",
            "Left town. No forwarding address."
        ];

        const ENDING_TEXT = [
            "Maya Chen left Millbrook three weeks later.\nShe told no one where she was going.",

            "The lesson plans she was returning that night?\nThey were for a struggling student named Oliver.\nTom was his afternoon teacher. Maya was his morning teacher.\nThey were coordinating to help him.",

            "Oliver's grades dropped after Maya left.\nHe had really liked her.",

            "No one ever learned the truth.\nWhy would they? The story was already complete.",

            "You were that story.\nYou could have stopped at any time.\nYou didn't.",

            "Thank you for playing.\n\n[Click to close]"
        ];

        // ============================================
        // GAME DATA
        // ============================================

        const NODES = [
            {
                id: 0,
                name: "Helen Marsh",
                location: "Apartment Window",
                description: "72, widowed. Watches the neighborhood.",
                position: { x: 300, y: 200 },
                connections: [1, 2],
                mutationOptions: [
                    { text: "Maya Chen SNUCK into Tom Bradley's apartment late last night.", label: "Add secrecy" },
                    { text: "Maya Chen was at Tom Bradley's apartment for HOURS last night.", label: "Add duration" },
                    { text: "Maya Chen went to see Tom Bradley last night. His wife wasn't home.", label: "Add context" }
                ]
            },
            {
                id: 1,
                name: "Derek Coleman",
                location: "The Tap Room",
                description: "45, bar owner. Loves a good story.",
                position: { x: 550, y: 180 },
                connections: [0, 2, 3],
                mutationOptions: [
                    { text: "She looked drunk when she left.", label: "Add judgment" },
                    { text: "This isn't the first time, either.", label: "Add history" },
                    { text: "Tom's been looking guilty all week.", label: "Add corroboration" }
                ]
            },
            {
                id: 2,
                name: "Sandra Wellington",
                location: "School Parking Lot",
                description: "41, PTA president. Competitive.",
                position: { x: 400, y: 350 },
                connections: [0, 1, 3, 4],
                mutationOptions: [
                    { text: "What kind of example is this for our CHILDREN?", label: "Add stakes" },
                    { text: "I always knew something was off about her.", label: "Add doubt" },
                    { text: "Other teachers have noticed things too.", label: "Add consensus" }
                ]
            },
            {
                id: 3,
                name: "Pastor Michael Greene",
                location: "Church Office",
                description: "58, sees moral decay everywhere.",
                position: { x: 700, y: 320 },
                connections: [1, 2, 4, 5],
                mutationOptions: [
                    { text: "The school needs to take action before more damage is done.", label: "Call for consequences" },
                    { text: "This is what happens when we abandon traditional values.", label: "Add ideology" },
                    { text: "I'll be praying for Tom's wife. That poor woman.", label: "Add victim narrative" }
                ]
            },
            {
                id: 4,
                name: "Jenny Zhao",
                location: "Coffee Shop",
                description: "29, runs local blog. Needs engagement.",
                position: { x: 550, y: 480 },
                connections: [2, 3, 5],
                mutationOptions: [
                    { text: "Sources confirm an ongoing situation at Millbrook Elementary.", label: "Add legitimacy" },
                    { text: "Why hasn't the school board addressed this?", label: "Add conspiracy" },
                    { text: "Developing story. More details to come.", label: "Add momentum" }
                ]
            },
            {
                id: 5,
                name: "Carol Bradley",
                location: "Bradley Home",
                description: "39, Tom's wife.",
                position: { x: 750, y: 550 },
                connections: [3, 4],
                mutationOptions: []
            }
        ];

        // ============================================
        // GAME STATE
        // ============================================

        const gameState = {
            currentNode: 0,
            rumorText: "Maya Chen went into Tom Bradley's apartment late last night.",
            infectedNodes: new Set([0]),
            mayaStage: 0,
            gamePhase: GAME_PHASE.INTRO,
            pendingMutation: true,
            endingIndex: 0,
            hoverNode: null,
            hoverButton: null,
            pulsePhase: 0,
            showInstructions: true
        };

        // ============================================
        // CANVAS SETUP
        // ============================================

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function getNodeAt(x, y) {
            for (let node of NODES) {
                const dx = x - node.position.x;
                const dy = y - node.position.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 45) {
                    return node.id;
                }
            }
            return null;
        }

        function getMutationButtonAt(x, y) {
            if (!gameState.pendingMutation) return null;

            const buttonWidth = 380;
            const buttonHeight = 60;
            const spacing = 20;
            const startX = (1280 - (3 * buttonWidth + 2 * spacing)) / 2;
            const buttonY = 640;

            if (y < buttonY || y > buttonY + buttonHeight) return null;

            for (let i = 0; i < 3; i++) {
                const buttonX = startX + i * (buttonWidth + spacing);
                if (x >= buttonX && x <= buttonX + buttonWidth) {
                    return i;
                }
            }
            return null;
        }

        function canMoveTo(targetNodeId) {
            const currentNode = NODES[gameState.currentNode];

            if (!currentNode.connections.includes(targetNodeId)) return false;
            if (gameState.infectedNodes.has(targetNodeId)) return false;
            if (gameState.pendingMutation) return false;

            return true;
        }

        function moveToNode(targetNodeId) {
            gameState.currentNode = targetNodeId;
            gameState.infectedNodes.add(targetNodeId);
            updateMayaDegradation();

            if (targetNodeId === 5) {
                triggerEnding();
            } else {
                gameState.pendingMutation = true;
            }
        }

        function applyMutation(choiceIndex) {
            const currentNode = NODES[gameState.currentNode];
            const mutation = currentNode.mutationOptions[choiceIndex];
            gameState.rumorText = mutation.text;
            gameState.pendingMutation = false;
        }

        function updateMayaDegradation() {
            const numInfected = gameState.infectedNodes.size;

            if (numInfected >= 5) {
                gameState.mayaStage = 4;
            } else if (numInfected >= 4) {
                gameState.mayaStage = 3;
            } else if (numInfected >= 3) {
                gameState.mayaStage = 2;
            } else if (numInfected >= 2) {
                gameState.mayaStage = 1;
            } else {
                gameState.mayaStage = 0;
            }
        }

        function triggerEnding() {
            gameState.gamePhase = GAME_PHASE.ENDING;
            gameState.mayaStage = 4;
            gameState.endingIndex = 0;
        }

        // ============================================
        // DRAWING FUNCTIONS
        // ============================================

        function wrapText(text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            ctx.font = '13px Arial';

            for (let word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);

                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }

            if (currentLine) {
                lines.push(currentLine);
            }

            return lines;
        }

        function drawTextWrapped(text, x, y, maxWidth, fontSize = 13, color = COLORS.WHITE, italic = false) {
            ctx.fillStyle = color;
            ctx.font = `${italic ? 'italic ' : ''}${fontSize}px Arial`;

            const lines = text.split('\n');
            let currentY = y;

            for (let line of lines) {
                const wrappedLines = wrapText(line, maxWidth);
                for (let wrappedLine of wrappedLines) {
                    ctx.fillText(wrappedLine, x, currentY);
                    currentY += fontSize + 5;
                }
            }
        }

        function drawNode(node) {
            const x = node.position.x;
            const y = node.position.y;
            const isHovered = gameState.hoverNode === node.id;

            let color;
            let radius = 45;
            let outline = false;

            if (node.id === gameState.currentNode) {
                // Current node - pulsing
                const pulse = Math.sin(gameState.pulsePhase) * 5;
                radius = 50 + pulse;
                color = COLORS.BRIGHT_YELLOW;
                outline = true;
            } else if (gameState.infectedNodes.has(node.id)) {
                // Infected
                color = COLORS.MUTED_PURPLE;
            } else if (canMoveTo(node.id)) {
                // Available
                color = COLORS.SOFT_BLUE;
                outline = true;
            } else {
                // Unavailable
                color = COLORS.DIM_GRAY;
                radius = 40;
            }

            // Draw circle
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();

            if (outline) {
                ctx.strokeStyle = COLORS.WHITE;
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            // Draw initial
            ctx.fillStyle = COLORS.WHITE;
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(node.name[0], x, y);

            // Draw checkmark if infected (but not current)
            if (gameState.infectedNodes.has(node.id) && node.id !== gameState.currentNode) {
                ctx.strokeStyle = COLORS.WHITE;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x - 10, y);
                ctx.lineTo(x - 5, y + 8);
                ctx.lineTo(x + 12, y - 8);
                ctx.stroke();
            }

            // Draw name below
            ctx.fillStyle = COLORS.WHITE;
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(node.name.split(' ')[0], x, y + 60);

            // Draw location below name
            ctx.fillStyle = COLORS.LIGHT_GRAY;
            ctx.font = '11px Arial';
            ctx.fillText(node.location, x, y + 75);

            // Draw tooltip on hover
            if (isHovered && node.id !== gameState.currentNode) {
                drawNodeTooltip(node, x, y);
            }

            // Draw "Click to spread" indicator for available nodes
            if (canMoveTo(node.id) && isHovered) {
                ctx.fillStyle = COLORS.WHITE;
                ctx.font = 'bold 12px Arial';
                ctx.fillText('▶ Click to spread', x, y - 65);
            }
        }

        function drawNodeTooltip(node, x, y) {
            const tooltipWidth = 200;
            const tooltipHeight = 60;
            const tooltipX = x + 60;
            const tooltipY = y - 30;

            // Draw tooltip background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
            ctx.fillRect(tooltipX, tooltipY, tooltipWidth, tooltipHeight);
            ctx.strokeStyle = COLORS.WHITE;
            ctx.lineWidth = 1;
            ctx.strokeRect(tooltipX, tooltipY, tooltipWidth, tooltipHeight);

            // Draw tooltip text
            ctx.fillStyle = COLORS.WHITE;
            ctx.font = 'bold 13px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(node.name, tooltipX + 8, tooltipY + 8);

            ctx.font = '11px Arial';
            ctx.fillStyle = COLORS.LIGHT_GRAY;
            drawTextWrapped(node.description, tooltipX + 8, tooltipY + 28, tooltipWidth - 16, 11, COLORS.LIGHT_GRAY);
        }

        function drawMayaPortrait() {
            const x = 20;
            const y = 20;
            const width = 180;
            const height = 220;

            // Draw label
            ctx.fillStyle = COLORS.LIGHT_PURPLE;
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText('MAYA CHEN:', x, y - 15);

            // Draw portrait box
            ctx.fillStyle = COLORS.DARK_PURPLE;
            ctx.fillRect(x, y, width, height);

            // Draw degradation based on stage
            const degradationColors = [
                '#8860a0',  // Stage 0: Purple/healthy
                '#6850a0',  // Stage 1: Darker purple
                '#504070',  // Stage 2: Duller
                '#403050',  // Stage 3: Very dull
                '#302030'   // Stage 4: Almost black
            ];

            ctx.fillStyle = degradationColors[gameState.mayaStage];
            ctx.fillRect(x + 10, y + 10, width - 20, height - 20);

            // Draw "M" for Maya
            ctx.fillStyle = COLORS.WHITE;
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('M', x + width/2, y + height/2);

            // Draw cracks based on degradation
            if (gameState.mayaStage > 0) {
                ctx.strokeStyle = COLORS.BLACK;
                ctx.lineWidth = 2;
                for (let i = 0; i < gameState.mayaStage; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x + 20 + i * 40, y);
                    ctx.lineTo(x + 40 + i * 40, y + height);
                    ctx.stroke();
                }
            }

            // Draw status text
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            drawTextWrapped(MAYA_STATUSES[gameState.mayaStage], x, y + height + 10, width, 12, COLORS.WHITE);
        }

        function drawRumorBox() {
            const x = 20;
            const y = 350;
            const width = 230;
            const height = 200;

            // Draw box
            ctx.fillStyle = COLORS.DARK_PURPLE;
            ctx.fillRect(x, y, width, height);
            ctx.strokeStyle = COLORS.LIGHT_PURPLE;
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);

            // Draw label
            ctx.fillStyle = COLORS.LIGHT_PURPLE;
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText('THE RUMOR:', x + 10, y + 10);

            // Draw rumor text
            drawTextWrapped('"' + gameState.rumorText + '"', x + 10, y + 35, width - 20, 13, COLORS.WHITE, true);
        }

        function drawMutationChoices() {
            if (!gameState.pendingMutation) return;

            const currentNode = NODES[gameState.currentNode];
            const options = currentNode.mutationOptions;

            // Draw overlay
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, 600, 1280, 120);

            // Draw instruction
            ctx.fillStyle = COLORS.WHITE;
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`How does ${currentNode.name.split(' ')[0]} change the story?`, 640, 615);

            // Draw buttons
            const buttonWidth = 380;
            const buttonHeight = 60;
            const spacing = 20;
            const startX = (1280 - (3 * buttonWidth + 2 * spacing)) / 2;
            const buttonY = 640;

            for (let i = 0; i < 3; i++) {
                const buttonX = startX + i * (buttonWidth + spacing);

                // Highlight if hovering
                const isHover = gameState.hoverButton === i;

                ctx.fillStyle = isHover ? COLORS.SOFT_BLUE : COLORS.DARK_BLUE;
                ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);

                ctx.strokeStyle = isHover ? COLORS.WHITE : COLORS.LIGHT_BLUE;
                ctx.lineWidth = 2;
                ctx.strokeRect(buttonX, buttonY, buttonWidth, buttonHeight);

                // Draw label
                ctx.fillStyle = COLORS.WHITE;
                ctx.font = '11px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';

                const label = options[i].label;
                ctx.fillText(`(${label})`, buttonX + 10, buttonY + 8);

                // Draw mutation preview
                ctx.font = '12px Arial';
                const previewText = options[i].text.substring(0, 80) + (options[i].text.length > 80 ? '...' : '');
                drawTextWrapped('"' + previewText + '"', buttonX + 10, buttonY + 25, buttonWidth - 20, 11, COLORS.WHITE);
            }
        }

        function drawIntro() {
            ctx.fillStyle = COLORS.BLACK;
            ctx.fillRect(0, 0, 1280, 720);

            // Title
            ctx.fillStyle = COLORS.WHITE;
            ctx.font = 'bold 60px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('RUMOR', 640, 100);

            // Tagline
            ctx.font = 'italic 18px Arial';
            ctx.fillStyle = COLORS.LIGHT_GRAY;
            ctx.fillText('"You are not the villain. You are the weapon."', 640, 150);

            // Main description
            ctx.font = '16px Arial';
            ctx.fillStyle = COLORS.WHITE;
            ctx.textAlign = 'center';

            const introLines = [
                'You play as gossip itself—a living piece of information',
                'spreading through a small town.',
                '',
                'With each person you possess, the rumor mutates,',
                'and an innocent woman\'s life is destroyed.',
            ];

            let y = 220;
            for (let line of introLines) {
                ctx.fillText(line, 640, y);
                y += 30;
            }

            // Instructions box
            const boxX = 340;
            const boxY = 370;
            const boxWidth = 600;
            const boxHeight = 240;

            ctx.fillStyle = COLORS.DARK_PURPLE;
            ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
            ctx.strokeStyle = COLORS.LIGHT_PURPLE;
            ctx.lineWidth = 2;
            ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

            ctx.fillStyle = COLORS.LIGHT_PURPLE;
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('HOW TO PLAY', 640, boxY + 25);

            ctx.fillStyle = COLORS.WHITE;
            ctx.font = '15px Arial';
            ctx.textAlign = 'left';

            const instructions = [
                '1. Choose how the current person changes the rumor',
                '   (click one of three options at the bottom)',
                '',
                '2. Click on a connected person to spread the rumor',
                '   (blue circles = available, gray = not reachable yet)',
                '',
                '3. Watch Maya Chen\'s life fall apart as you spread',
                '',
                '4. The game ends when the rumor reaches Carol Bradley'
            ];

            y = boxY + 60;
            for (let line of instructions) {
                ctx.fillText(line, boxX + 30, y);
                y += 24;
            }

            // Start button
            const buttonX = 490;
            const buttonY = 640;
            const buttonWidth = 300;
            const buttonHeight = 50;

            ctx.fillStyle = COLORS.SOFT_BLUE;
            ctx.fillRect(buttonX, buttonY, buttonWidth, buttonHeight);
            ctx.strokeStyle = COLORS.WHITE;
            ctx.lineWidth = 2;
            ctx.strokeRect(buttonX, buttonY, buttonWidth, buttonHeight);

            ctx.fillStyle = COLORS.WHITE;
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Click to Begin', 640, buttonY + 25);
        }

        function drawEnding() {
            ctx.fillStyle = COLORS.BLACK;
            ctx.fillRect(0, 0, 1280, 720);

            const text = ENDING_TEXT[gameState.endingIndex];
            const lines = text.split('\n');

            ctx.fillStyle = COLORS.WHITE;
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const lineHeight = 30;
            const startY = 360 - (lines.length * lineHeight) / 2;

            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], 640, startY + i * lineHeight);
            }
        }

        function drawLegend() {
            const x = 1020;
            const y = 20;
            const width = 240;

            ctx.fillStyle = COLORS.DARK_PURPLE;
            ctx.fillRect(x, y, width, 150);
            ctx.strokeStyle = COLORS.LIGHT_PURPLE;
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, width, 150);

            ctx.fillStyle = COLORS.LIGHT_PURPLE;
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText('LEGEND', x + 10, y + 8);

            // Draw legend items
            const items = [
                { color: COLORS.BRIGHT_YELLOW, text: 'Current person' },
                { color: COLORS.SOFT_BLUE, text: 'Can spread to' },
                { color: COLORS.MUTED_PURPLE, text: 'Already infected' },
                { color: COLORS.DIM_GRAY, text: 'Not reachable yet' }
            ];

            let itemY = y + 35;
            for (let item of items) {
                // Draw colored circle
                ctx.beginPath();
                ctx.arc(x + 20, itemY, 8, 0, Math.PI * 2);
                ctx.fillStyle = item.color;
                ctx.fill();

                // Draw text
                ctx.fillStyle = COLORS.WHITE;
                ctx.font = '12px Arial';
                ctx.fillText(item.text, x + 35, itemY - 6);

                itemY += 28;
            }
        }

        function drawConnections() {
            ctx.strokeStyle = COLORS.LIGHT_GRAY;
            ctx.lineWidth = 2;

            for (let node of NODES) {
                for (let connId of node.connections) {
                    if (connId > node.id) { // Only draw once
                        const other = NODES[connId];
                        ctx.beginPath();
                        ctx.moveTo(node.position.x, node.position.y);
                        ctx.lineTo(other.position.x, other.position.y);
                        ctx.stroke();
                    }
                }
            }
        }

        function render() {
            // Clear
            ctx.fillStyle = COLORS.DARK_GRAY;
            ctx.fillRect(0, 0, 1280, 720);

            if (gameState.gamePhase === GAME_PHASE.INTRO) {
                drawIntro();
                return;
            }

            if (gameState.gamePhase === GAME_PHASE.ENDING) {
                drawEnding();
                return;
            }

            // Draw connections
            drawConnections();

            // Draw nodes
            for (let node of NODES) {
                drawNode(node);
            }

            // Draw UI
            drawMayaPortrait();
            drawRumorBox();
            drawMutationChoices();
            drawLegend();
        }

        // ============================================
        // INPUT HANDLING
        // ============================================

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (gameState.gamePhase === GAME_PHASE.INTRO) {
                // Any click starts the game
                gameState.gamePhase = GAME_PHASE.PLAYING;
                return;
            }

            if (gameState.gamePhase === GAME_PHASE.ENDING) {
                gameState.endingIndex++;
                if (gameState.endingIndex >= ENDING_TEXT.length) {
                    gameState.gamePhase = GAME_PHASE.COMPLETE;
                    window.close();
                }
                return;
            }

            if (gameState.gamePhase !== GAME_PHASE.PLAYING) return;

            // Check mutation choice
            if (gameState.pendingMutation) {
                const buttonIndex = getMutationButtonAt(x, y);
                if (buttonIndex !== null) {
                    applyMutation(buttonIndex);

                    if (gameState.currentNode === 5) {
                        triggerEnding();
                    }
                }
                return;
            }

            // Check node click
            const nodeId = getNodeAt(x, y);
            if (nodeId !== null && canMoveTo(nodeId)) {
                moveToNode(nodeId);
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            gameState.hoverNode = getNodeAt(x, y);
            gameState.hoverButton = getMutationButtonAt(x, y);
        });

        // ============================================
        // GAME LOOP
        // ============================================

        function gameLoop() {
            gameState.pulsePhase += 0.05;
            render();
            requestAnimationFrame(gameLoop);
        }

        // Start the game
        gameLoop();
    </script>
</body>
</html>
